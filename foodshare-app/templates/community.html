{% extends "base.html" %}
{% block title %}Community - FoodShare{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/community.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="mb-4">
                <i class="fas fa-comments"></i> Community Posts
            </h1>
        </div>
        <div class="col-lg-4">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newPostModal">
                <i class="fas fa-plus"></i> New Post
            </button>
        </div>
    </div>

    <div class="row">
        {% if posts %}
            {% for post in posts %}
            <div class="col-lg-8 mb-4" id="post-{{ post.id }}">
                <div class="card {% if post.status == 'resolved' %}post-resolved{% endif %}">
                    {% if post.image_url %}
                        <img src="{{ url_for('static', filename='uploads/' ~ post.image_url) }}" 
                             class="card-img-top" alt="Post Image">
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title">
                                {{ post.title }}
                                {% if post.status == 'resolved' %}
                                <span class="badge bg-success ms-2">
                                    <i class="fas fa-check-circle"></i> Resolved
                                </span>
                                {% endif %}
                            </h5>
                            {% if post.user_id == 1 %}
                            <!-- Post actions dropdown for author only -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if post.status != 'resolved' %}
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="markPostAsResolved({{ post.id }}); return false;">
                                            <i class="fas fa-check-circle text-success"></i> Mark as Resolved
                                        </a>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }}); return false;">
                                            <i class="fas fa-trash"></i> Delete Post
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted">
                            <i class="fas fa-user-circle"></i> By {{ post.author.username }}
                        </h6>
                        <p class="card-text">{{ post.content }}</p>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="fas fa-tag"></i> <strong>Type:</strong> {{ post.food_type }}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="fas fa-weight"></i> <strong>Quantity:</strong> {{ post.quantity }}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> {{ post.location }}
                                </small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> {{ post.timestamp }}
                            </small>

                            <div>
                                <button class="btn btn-outline-primary btn-sm reply-button me-2" 
                                        data-post-id="{{ post.id }}">
                                    <i class="fas fa-reply"></i> Reply <span class="replies-count">({{ post.replies|length }})</span>
                                </button>
                                <button class="btn btn-outline-success btn-sm like-button" 
                                        data-post-id="{{ post.id }}">
                                    <i class="fas fa-heart"></i> <span class="likes-count">{{ post.likes }}</span>
                                </button>
                            </div>
                        </div>

                        <!-- Replies Section -->
                        <div class="replies-section mt-3" id="replies-section-{{ post.id }}" style="display: none;">
                            <hr>
                            <!-- Reply Form -->
                            <div class="reply-form mb-3">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control reply-input" 
                                           placeholder="Write a reply..." 
                                           data-post-id="{{ post.id }}">
                                    <button class="btn btn-success submit-reply-btn" 
                                            data-post-id="{{ post.id }}">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Replies List -->
                            <div class="replies-list" id="replies-list-{{ post.id }}">
                                <!-- Replies will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No posts yet. Be the first to share!
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Create Post Modal -->
<div class="modal fade" id="newPostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-pen"></i> Create New Post
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="postForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="content" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Food Type</label>
                        <input type="text" class="form-control" name="food_type">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="text" class="form-control" name="quantity">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" name="location">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Upload Image</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="submitPostBtn">Post</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Post submission handler
    const submitPostBtn = document.getElementById('submitPostBtn');
    if (submitPostBtn) {
        submitPostBtn.addEventListener('click', submitPost);
    }

    // Like button handlers
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            likePost(postId, this);
        });
    });

    // Reply button handlers - toggle reply section
    document.querySelectorAll('.reply-button').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            toggleRepliesSection(postId);
        });
    });

    // Submit reply handlers
    document.querySelectorAll('.submit-reply-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            submitReply(postId);
        });
    });

    // Allow Enter key to submit reply
    document.querySelectorAll('.reply-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const postId = this.dataset.postId;
                submitReply(postId);
            }
        });
    });
});

function submitPost() {
    const form = document.getElementById('postForm');
    
    if (!form) {
        console.error('Form element not found!');
        alert('Error: Form not found. Please refresh the page.');
        return;
    }
    
    const formData = new FormData(form);
    formData.append('user_id', 1); // Default user ID

    fetch('/api/posts', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Error creating post');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Post created:', data);
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('newPostModal'));
        if (modal) {
            modal.hide();
        }
        // Clear form
        form.reset();
        // Reload page to show new post
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Error creating post');
    });
}

function likePost(postId, button) {
    fetch(`/api/posts/${postId}/like`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        const likesCount = button.querySelector('.likes-count');
        likesCount.textContent = data.likes;
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function toggleRepliesSection(postId) {
    const repliesSection = document.getElementById(`replies-section-${postId}`);
    const isHidden = repliesSection.style.display === 'none';
    
    if (isHidden) {
        repliesSection.style.display = 'block';
        loadReplies(postId);
    } else {
        repliesSection.style.display = 'none';
    }
}

function loadReplies(postId) {
    fetch(`/api/posts/${postId}/replies`)
    .then(response => response.json())
    .then(replies => {
        displayReplies(postId, replies);
    })
    .catch(error => {
        console.error('Error loading replies:', error);
    });
}

function displayReplies(postId, replies) {
    const repliesList = document.getElementById(`replies-list-${postId}`);
    
    if (replies.length === 0) {
        repliesList.innerHTML = '<p class="text-muted small">No replies yet. Be the first to reply!</p>';
        return;
    }
    
    repliesList.innerHTML = replies.map(reply => `
        <div class="reply-item mb-2 p-2 bg-light rounded">
            <div class="d-flex justify-content-between">
                <strong class="text-primary">${reply.author}</strong>
                <small class="text-muted">${formatTimestamp(reply.timestamp)}</small>
            </div>
            <p class="mb-0 mt-1">${escapeHtml(reply.content)}</p>
        </div>
    `).join('');
}

function submitReply(postId) {
    const input = document.querySelector(`.reply-input[data-post-id="${postId}"]`);
    const content = input.value.trim();
    
    if (!content) {
        alert('Please enter a reply');
        return;
    }
    
    fetch(`/api/posts/${postId}/replies`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            content: content,
            user_id: 1 // Default user ID
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Reply created:', data);
        input.value = ''; // Clear input
        loadReplies(postId); // Reload replies
        
        // Update reply count
        const replyButton = document.querySelector(`.reply-button[data-post-id="${postId}"]`);
        const repliesCountSpan = replyButton.querySelector('.replies-count');
        const currentCount = parseInt(repliesCountSpan.textContent.match(/\d+/)[0]);
        repliesCountSpan.textContent = `(${currentCount + 1})`;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating reply');
    });
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Mark post as resolved
function markPostAsResolved(postId) {
    if (!confirm('Mark this post as resolved?')) return;
    
    fetch(`/api/posts/${postId}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 1 // Demo user
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'resolved') {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Failed to mark post as resolved');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error marking post as resolved');
    });
}

// Delete post
function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
    
    fetch(`/api/posts/${postId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 1 // Demo user
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            // Remove the post from the DOM
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                postElement.remove();
            }
            alert('Post deleted successfully');
        } else {
            alert('Failed to delete post');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting post');
    });
}

</script>
{% endblock %}
