{% extends "base.html" %}
{% block title %}Gardens - FoodShare{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="mb-4">
                <i class="fas fa-leaf"></i> Community Gardens
            </h1>
        </div>
        <div class="col-lg-4">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newGardenModal">
                <i class="fas fa-plus"></i> New Garden
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="gardenSearch" placeholder="Search gardens by name or location...">
            </div>
        </div>
    </div>

    <!-- Gardens Grid -->
    <div class="row g-4" id="gardensContainer">
        {% if gardens %}
            {% for garden in gardens %}
            <div class="col-lg-4 col-md-6 garden-item" data-name="{{ garden.name|lower }}" data-location="{{ garden.location|lower }}">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-seedling"></i> {{ garden.name }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ garden.description }}</p>
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> {{ garden.location }}
                            </small><br>
                            <small class="text-muted">
                                <i class="fas fa-sprout"></i> <strong>Plants:</strong> {{ garden.plants }}
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm flex-grow-1" onclick="viewGardenPlots({{ garden.id }}, '{{ garden.name }}')">
                                <i class="fas fa-th"></i> View Plots
                            </button>
                            <button class="btn btn-success btn-sm follow-btn" id="follow-btn-{{ garden.id }}" onclick="toggleFollowGarden({{ garden.id }}, '{{ garden.name }}')">
                                <i class="fas fa-user-plus"></i> Follow
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No gardens yet. Start the first one!
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- New Garden Modal -->
<div class="modal fade" id="newGardenModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Create New Garden
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left side - Form -->
                    <div class="col-md-5">
                        <form id="gardenForm">
                            <div class="mb-3">
                                <label class="form-label">Garden Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="location">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Plants Growing</label>
                                <input type="text" class="form-control" name="plants" placeholder="e.g., tomatoes, lettuce, herbs">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Garden Grid Size</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Rows</label>
                                        <input type="number" class="form-control" id="newGardenRows" name="rows" value="5" min="3" max="10">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Columns</label>
                                        <input type="number" class="form-control" id="newGardenCols" name="cols" value="5" min="3" max="10">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Right side - Plot Designer -->
                    <div class="col-md-7">
                        <div class="p-3 bg-light rounded">
                            <h6 class="mb-3">
                                <i class="fas fa-paint-brush"></i> Design Your Garden Layout
                            </h6>
                            <p class="small text-muted mb-3">
                                Click on plots to cycle through different types: Available (green), Water Source (blue), Tool Hub (orange), or Unavailable (gray).
                            </p>
                            
                            <!-- Legend for designer -->
                            <div class="mb-3 d-flex flex-wrap gap-3">
                                <div>
                                    <span class="plot-legend" style="background-color: #90EE90;"></span>
                                    <small>Available</small>
                                </div>
                                <div>
                                    <span class="plot-legend" style="background-color: #87CEEB;"></span>
                                    <small>Water Source</small>
                                </div>
                                <div>
                                    <span class="plot-legend" style="background-color: #FFA500;"></span>
                                    <small>Tool Hub</small>
                                </div>
                                <div>
                                    <span class="plot-legend" style="background-color: #D3D3D3;"></span>
                                    <small>Not Available</small>
                                </div>
                            </div>
                            
                            <!-- Preview Grid -->
                            <div id="designerGrid" class="garden-grid mx-auto mb-3"></div>
                            
                            <div class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllBtn">
                                    <i class="fas fa-redo"></i> Make All Available
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="submitGardenBtn">Create Garden</button>
            </div>
        </div>
    </div>
</div>

<!-- Plot Details Modal -->
<div class="modal fade" id="plotDetailsModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1B5E3F; color: white;">
                <h5 class="modal-title" style="color: white;">
                    <i class="fas fa-info-circle"></i> Plot Details: <span id="detailPlotNumber"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="text-muted">Status</h6>
                    <p id="detailPlotStatus" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailOwnerSection" style="display: none;">
                    <h6 class="text-muted">Owner</h6>
                    <p id="detailPlotOwner" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailWaterSection" style="display: none;">
                    <h6 class="text-muted"><i class="fas fa-tint"></i> Water Available</h6>
                    <p id="detailPlotWater" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailToolsSection" style="display: none;">
                    <h6 class="text-muted"><i class="fas fa-tools"></i> Tools Available</h6>
                    <p id="detailPlotTools" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailSoilSection" style="display: none;">
                    <h6 class="text-muted"><i class="fas fa-mountain"></i> Soil Type</h6>
                    <p id="detailPlotSoil" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailSunlightSection" style="display: none;">
                    <h6 class="text-muted"><i class="fas fa-sun"></i> Sunlight Level</h6>
                    <p id="detailPlotSunlight" class="mb-0"></p>
                </div>
                
                <div class="mb-3" id="detailNotesSection" style="display: none;">
                    <h6 class="text-muted"><i class="fas fa-sticky-note"></i> Notes</h6>
                    <p id="detailPlotNotes" class="mb-0"></p>
                </div>
                
                <div id="detailPlotActions" class="mt-4"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Garden Plots Modal -->
<div class="modal fade" id="gardenPlotsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1B5E3F; color: white;">
                <h5 class="modal-title" id="gardenPlotsTitle" style="color: white;">
                    <i class="fas fa-th"></i> Garden Plots
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Legend -->
                <div class="mb-4 p-3 bg-light rounded">
                    <h6 class="mb-3">Plot Legend:</h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span class="plot-legend" style="background-color: #90EE90;"></span>
                            <small>Available</small>
                        </div>
                        <div>
                            <span class="plot-legend" style="background-color: #87CEEB;"></span>
                            <small>Water Source</small>
                        </div>
                        <div>
                            <span class="plot-legend" style="background-color: #FFA500;"></span>
                            <small>Tool Hub</small>
                        </div>
                        <div>
                            <span class="plot-legend" style="background-color: #FFB6C1;"></span>
                            <small>Your Plot</small>
                        </div>
                        <div>
                            <span class="plot-legend" style="background-color: #FFD700;"></span>
                            <small>Taken</small>
                        </div>
                        <div>
                            <span class="plot-legend" style="background-color: #D3D3D3;"></span>
                            <small>Not Available</small>
                        </div>
                    </div>
                </div>

                <!-- Garden Grid -->
                <div class="position-relative">
                    <!-- Compass Rose -->
                    <div class="compass-rose">
                        <div class="compass-direction compass-north">N</div>
                        <div class="compass-direction compass-east">E</div>
                        <div class="compass-direction compass-south">S</div>
                        <div class="compass-direction compass-west">W</div>
                    </div>
                    
                    <div id="gardenGrid" class="garden-grid mx-auto"></div>
                    
                    <!-- Scale Indicator -->
                    <div class="scale-indicator mt-3 text-center">
                        <i class="fas fa-ruler-horizontal"></i> <small class="text-muted">Each plot = 10ft √ó 10ft</small>
                    </div>
                </div>
                
                <!-- Selected Plot Info -->
                <div id="plotInfo" class="mt-4 p-3 bg-light rounded" style="display: none;">
                    <h6>Selected Plot: <span id="selectedPlotId"></span></h6>
                    <p class="mb-2">Status: <strong id="plotStatus"></strong></p>
                    <div id="plotActions"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal z-index fix for nested modals */
#plotDetailsModal {
    z-index: 1060 !important;
}

#plotDetailsModal ~ .modal-backdrop {
    z-index: 1055 !important;
}

.garden-grid {
    display: inline-grid;
    gap: 8px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.garden-plot {
    width: 60px;
    height: 60px;
    border: 2px solid #333;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.75rem;
    transition: all 0.2s;
    position: relative;
}

/* Smaller plots for the designer */
#designerGrid .garden-plot {
    width: 45px;
    height: 45px;
    font-size: 0.65rem;
}

.garden-plot:hover:not(.plot-null) {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.plot-available {
    background-color: #90EE90;
}

.plot-taken {
    background-color: #FFD700;
}

.plot-mine {
    background-color: #FFB6C1;
}

/* Compass Rose Styles */
.compass-rose {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 60px;
    height: 60px;
    z-index: 10;
}

.compass-direction {
    position: absolute;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    border: 2px solid #28a745;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.7rem;
    color: #28a745;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.compass-north {
    top: 0;
    left: 50%;
    transform: translateX(-50%);
}

.compass-east {
    top: 50%;
    right: 0;
    transform: translateY(-50%);
}

.compass-south {
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
}

.compass-west {
    top: 50%;
    left: 0;
    transform: translateY(-50%);
}

/* Scale Indicator */
.scale-indicator {
    font-size: 0.9rem;
    color: #6c757d;
}

.plot-null {
    background-color: #D3D3D3;
    cursor: not-allowed;
    opacity: 0.5;
}

/* Water Source Plots */
.plot-water {
    background-color: #87CEEB;
    cursor: pointer;
}

.plot-water::after {
    content: '\f043';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: #1E90FF;
    font-size: 1.5rem;
}

/* Tool Hub Plots */
.plot-tools {
    background-color: #FFA500;
    cursor: pointer;
}

.plot-tools::after {
    content: '\f0ad';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: #FF8C00;
    font-size: 1.5rem;
}

/* Designer mode - null plots should be clickable */
#designerGrid .plot-null {
    cursor: pointer;
    opacity: 0.7;
}

#designerGrid .plot-null:hover {
    opacity: 0.9;
}

.plot-legend {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 1px solid #333;
    border-radius: 3px;
    margin-right: 5px;
    vertical-align: middle;
}

.garden-plot.selected {
    border-color: #0066cc;
    border-width: 3px;
}
</style>

<script>
// Search functionality
document.getElementById('gardenSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const gardenItems = document.querySelectorAll('.garden-item');
    
    gardenItems.forEach(item => {
        const name = item.dataset.name;
        const location = item.dataset.location;
        
        if (name.includes(searchTerm) || location.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Designer grid state
let designerPlotStates = [];
let isSubmittingGarden = false;  // Flag to prevent double submissions

// Debug: Log initial state
console.log('üèÅ Script loaded. Initial designerPlotStates:', designerPlotStates);

// Initialize designer grid when modal opens or grid size changes
function initializeDesignerGrid() {
    console.log('üîß initializeDesignerGrid() called');
    const rows = parseInt(document.getElementById('newGardenRows').value) || 5;
    const cols = parseInt(document.getElementById('newGardenCols').value) || 5;
    const totalPlots = rows * cols;
    
    // Preserve existing states when resizing, or initialize all as available
    const oldStates = [...designerPlotStates];
    designerPlotStates = new Array(totalPlots);
    
    for (let i = 0; i < totalPlots; i++) {
        // Keep old state if it exists, otherwise set as available
        designerPlotStates[i] = (i < oldStates.length) ? oldStates[i] : 'available';
    }
    
    console.log('üîß Designer grid initialized:', {rows, cols, totalPlots, statesLength: designerPlotStates.length});
    console.log('üîß First 5 states:', designerPlotStates.slice(0, 5));
    renderDesignerGrid(rows, cols);
}

// Render the designer grid
function renderDesignerGrid(rows, cols) {
    const grid = document.getElementById('designerGrid');
    grid.style.gridTemplateColumns = `repeat(${cols}, 45px)`;
    grid.innerHTML = '';
    
    const totalPlots = rows * cols;
    
    for (let i = 0; i < totalPlots; i++) {
        const plotDiv = document.createElement('div');
        plotDiv.className = 'garden-plot';
        plotDiv.dataset.index = i;
        
        const status = designerPlotStates[i];
        
        if (status === 'available') {
            plotDiv.classList.add('plot-available');
            plotDiv.textContent = `#${i + 1}`;
        } else if (status === 'water') {
            plotDiv.classList.add('plot-water');
            // Icon added via CSS
        } else if (status === 'tools') {
            plotDiv.classList.add('plot-tools');
            // Icon added via CSS
        } else {
            plotDiv.classList.add('plot-null');
            plotDiv.innerHTML = '<i class="fas fa-times"></i>';
        }
        
        // Toggle on click
        plotDiv.onclick = () => toggleDesignerPlot(i);
        
        grid.appendChild(plotDiv);
    }
}

// Toggle plot type in designer (cycles through: available -> water -> tools -> null -> available)
function toggleDesignerPlot(index) {
    const currentState = designerPlotStates[index];
    
    if (currentState === 'available') {
        designerPlotStates[index] = 'water';
    } else if (currentState === 'water') {
        designerPlotStates[index] = 'tools';
    } else if (currentState === 'tools') {
        designerPlotStates[index] = 'null';
    } else {
        designerPlotStates[index] = 'available';
    }
    
    const rows = parseInt(document.getElementById('newGardenRows').value) || 5;
    const cols = parseInt(document.getElementById('newGardenCols').value) || 5;
    renderDesignerGrid(rows, cols);
}

// Clear all - make all plots available
document.getElementById('clearAllBtn').addEventListener('click', function() {
    const rows = parseInt(document.getElementById('newGardenRows').value) || 5;
    const cols = parseInt(document.getElementById('newGardenCols').value) || 5;
    const totalPlots = rows * cols;
    designerPlotStates = new Array(totalPlots).fill('available');
    renderDesignerGrid(rows, cols);
    console.log('üßπ Cleared all plots to available');
});

// Update grid when rows/cols change
document.getElementById('newGardenRows').addEventListener('change', initializeDesignerGrid);
document.getElementById('newGardenCols').addEventListener('change', initializeDesignerGrid);

// Initialize designer grid when modal is shown
const modal = document.getElementById('newGardenModal');
if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
        console.log('üé¨ Modal opened, initializing designer...');
        initializeDesignerGrid();
    });
    console.log('‚úÖ Modal event listener attached successfully');
} else {
    console.error('‚ùå Could not find newGardenModal element!');
}

// Reset submission flag when modal is hidden
document.getElementById('newGardenModal').addEventListener('hidden.bs.modal', function() {
    isSubmittingGarden = false;
    document.getElementById('submitGardenBtn').disabled = false;
    document.getElementById('submitGardenBtn').innerHTML = 'Create Garden';
    document.getElementById('gardenForm').reset();
});

// Store current garden plots data
let currentGardenData = {};

// View garden plots
function viewGardenPlots(gardenId, gardenName) {
    document.getElementById('gardenPlotsTitle').innerHTML = `<i class="fas fa-th"></i> ${gardenName} - Garden Plots`;
    
    // Fetch garden plot data
    fetch(`/api/gardens/${gardenId}/plots`)
        .then(response => response.json())
        .then(data => {
            currentGardenData = data;
            renderGardenGrid(data);
            const modal = new bootstrap.Modal(document.getElementById('gardenPlotsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load garden plots');
        });
}

// Render the garden grid
function renderGardenGrid(data) {
    const grid = document.getElementById('gardenGrid');
    const plots = data.plots;
    const rows = data.rows;
    const cols = data.cols;
    
    grid.style.gridTemplateColumns = `repeat(${cols}, 60px)`;
    grid.innerHTML = '';
    
    for (let i = 0; i < rows * cols; i++) {
        const plot = plots[i];
        const plotDiv = document.createElement('div');
        plotDiv.className = 'garden-plot';
        plotDiv.dataset.index = i;
        
        if (plot.status === 'null') {
            plotDiv.classList.add('plot-null');
            plotDiv.textContent = '';
        } else if (plot.status === 'water') {
            plotDiv.classList.add('plot-water');
            // Icon shown via CSS
            plotDiv.onclick = () => selectPlot(i, plot);
        } else if (plot.status === 'tools') {
            plotDiv.classList.add('plot-tools');
            // Icon shown via CSS
            plotDiv.onclick = () => selectPlot(i, plot);
        } else if (plot.status === 'available') {
            plotDiv.classList.add('plot-available');
            plotDiv.textContent = `#${i + 1}`;
            plotDiv.onclick = () => selectPlot(i, plot);
        } else if (plot.status === 'mine') {
            plotDiv.classList.add('plot-mine');
            plotDiv.textContent = `#${i + 1}`;
            plotDiv.innerHTML += '<br><small>YOU</small>';
            plotDiv.onclick = () => selectPlot(i, plot);
        } else if (plot.status === 'taken') {
            plotDiv.classList.add('plot-taken');
            plotDiv.textContent = `#${i + 1}`;
            plotDiv.onclick = () => selectPlot(i, plot);
        }
        
        grid.appendChild(plotDiv);
    }
}

// Select a plot
function selectPlot(index, plot) {
    // Remove previous selection
    document.querySelectorAll('.garden-plot').forEach(p => p.classList.remove('selected'));
    
    // Add selection to clicked plot
    document.querySelector(`[data-index="${index}"]`).classList.add('selected');
    
    // Show plot details modal
    showPlotDetailsModal(index, plot);
}

// Show plot details in a modal
function showPlotDetailsModal(index, plot) {
    // Set plot number
    document.getElementById('detailPlotNumber').textContent = `#${index + 1}`;
    
    // Set status with special handling for water and tools
    let statusText = plot.status.charAt(0).toUpperCase() + plot.status.slice(1);
    if (plot.status === 'water') {
        statusText = 'Water Source';
    } else if (plot.status === 'tools') {
        statusText = 'Tool Hub';
    }
    document.getElementById('detailPlotStatus').textContent = statusText;
    
    // Show/hide owner section
    const ownerSection = document.getElementById('detailOwnerSection');
    if (plot.status === 'mine' || plot.status === 'taken') {
        const ownerText = plot.status === 'mine' ? 'You' : (plot.owner || 'Another gardener');
        document.getElementById('detailPlotOwner').textContent = ownerText;
        ownerSection.style.display = 'block';
    } else {
        ownerSection.style.display = 'none';
    }
    
    // Show/hide plot attributes sections (only for claimed plots)
    const showAttributes = (plot.status === 'mine' || plot.status === 'taken');
    
    const waterSection = document.getElementById('detailWaterSection');
    const toolsSection = document.getElementById('detailToolsSection');
    const soilSection = document.getElementById('detailSoilSection');
    const sunlightSection = document.getElementById('detailSunlightSection');
    const notesSection = document.getElementById('detailNotesSection');
    
    if (showAttributes) {
        // Water available
        if (plot.water_available !== null && plot.water_available !== undefined) {
            document.getElementById('detailPlotWater').textContent = plot.water_available ? 'Yes' : 'No';
            waterSection.style.display = 'block';
        } else {
            waterSection.style.display = 'none';
        }
        
        // Tools available
        if (plot.tools_available !== null && plot.tools_available !== undefined) {
            document.getElementById('detailPlotTools').textContent = plot.tools_available ? 'Yes' : 'No';
            toolsSection.style.display = 'block';
        } else {
            toolsSection.style.display = 'none';
        }
        
        // Soil type
        if (plot.soil_type) {
            document.getElementById('detailPlotSoil').textContent = plot.soil_type;
            soilSection.style.display = 'block';
        } else {
            soilSection.style.display = 'none';
        }
        
        // Sunlight level
        if (plot.sunlight_level) {
            document.getElementById('detailPlotSunlight').textContent = plot.sunlight_level;
            sunlightSection.style.display = 'block';
        } else {
            sunlightSection.style.display = 'none';
        }
        
        // Notes
        if (plot.notes) {
            document.getElementById('detailPlotNotes').textContent = plot.notes;
            notesSection.style.display = 'block';
        } else {
            notesSection.style.display = 'none';
        }
    } else {
        waterSection.style.display = 'none';
        toolsSection.style.display = 'none';
        soilSection.style.display = 'none';
        sunlightSection.style.display = 'none';
        notesSection.style.display = 'none';
    }
    
    // Show appropriate actions
    const plotActions = document.getElementById('detailPlotActions');
    if (plot.status === 'available') {
        plotActions.innerHTML = `
            <button class="btn btn-success w-100" onclick="claimPlot(${index})">
                <i class="fas fa-check"></i> Claim This Plot
            </button>
        `;
    } else if (plot.status === 'mine') {
        plotActions.innerHTML = `
            <button class="btn btn-danger w-100" onclick="releasePlot(${index})">
                <i class="fas fa-times"></i> Release This Plot
            </button>
        `;
    } else if (plot.status === 'water') {
        plotActions.innerHTML = '<p class="text-info text-center mb-0"><i class="fas fa-tint"></i> This is a water source for the garden.</p>';
    } else if (plot.status === 'tools') {
        plotActions.innerHTML = '<p class="text-warning text-center mb-0"><i class="fas fa-tools"></i> This is a tool hub where gardening tools are stored.</p>';
    } else if (plot.status === 'taken') {
        plotActions.innerHTML = '';
    } else {
        plotActions.innerHTML = '<p class="text-muted text-center mb-0">This area is not available for planting</p>';
    }
    
    // Show the modal with proper backdrop
    const plotModal = document.getElementById('plotDetailsModal');
    const modal = new bootstrap.Modal(plotModal, {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    modal.show();
    
    // Ensure the backdrop appears above the garden plots modal
    setTimeout(() => {
        const backdrop = document.querySelector('.modal-backdrop:last-of-type');
        if (backdrop) {
            backdrop.style.zIndex = '1055';
        }
    }, 10);
}

// Claim a plot
function claimPlot(index) {
    // Close the details modal first
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('plotDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    fetch(`/api/gardens/${currentGardenData.garden_id}/plots/${index}/claim`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: 1}) // Using demo user
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the grid
            viewGardenPlots(currentGardenData.garden_id, currentGardenData.garden_name);
            alert('Plot claimed successfully!');
        } else {
            alert('Failed to claim plot: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to claim plot');
    });
}

// Release a plot
function releasePlot(index) {
    if (!confirm('Are you sure you want to release this plot?')) return;
    
    // Close the details modal first
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('plotDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    fetch(`/api/gardens/${currentGardenData.garden_id}/plots/${index}/release`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: 1}) // Using demo user
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the grid
            viewGardenPlots(currentGardenData.garden_id, currentGardenData.garden_name);
            alert('Plot released successfully!');
        } else {
            alert('Failed to release plot: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to release plot');
    });
}

// Create new garden
document.getElementById('submitGardenBtn').addEventListener('click', function(e) {
    e.preventDefault();  // Prevent any default behavior
    e.stopPropagation(); // Stop event from bubbling
    
    const btn = this;
    
    // IMMEDIATELY disable the button
    if (btn.disabled || isSubmittingGarden) {
        console.log('‚õî Button already disabled or submission in progress');
        return;
    }
    
    btn.disabled = true;
    isSubmittingGarden = true;
    
    const form = document.getElementById('gardenForm');
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        btn.disabled = false;
        isSubmittingGarden = false;
        return;
    }
    
    const formData = new FormData(form);
    const gardenName = formData.get('name').trim();
    
    // IMPORTANT: Capture plot states NOW before any async operations
    const plotStatesToSend = [...designerPlotStates];  // Make a copy
    console.log('üíæ Captured plot states:', plotStatesToSend);
    console.log('üíæ Length:', plotStatesToSend.length);
    
    // Validation: Ensure we have plot states
    if (!plotStatesToSend || plotStatesToSend.length === 0) {
        console.error('‚ùå ERROR: Plot states array is empty!');
        alert('Error: Garden layout is not initialized. Please close and reopen the form.');
        btn.disabled = false;
        isSubmittingGarden = false;
        return;
    }
    
    // Check if garden name already exists
    fetch('/api/gardens')
        .then(response => response.json())
        .then(existingGardens => {
            const nameExists = existingGardens.some(g => g.name.toLowerCase() === gardenName.toLowerCase());
            
            if (nameExists) {
                alert(`A garden named "${gardenName}" already exists! Please choose a different name.`);
                btn.disabled = false;
                isSubmittingGarden = false;
                return;
            }
            
            // Proceed with submission if name is unique
            submitGarden(formData, gardenName, plotStatesToSend, btn);
        })
        .catch(error => {
            console.error('Error checking for duplicates:', error);
            // Proceed anyway if check fails
            submitGarden(formData, gardenName, plotStatesToSend, btn);
        });
});

// Separate function to handle the actual submission
function submitGarden(formData, gardenName, plotStatesToSend, btn) {
    // Button is already disabled, just update the text
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    const gardenData = {
        name: gardenName,
        description: formData.get('description'),
        location: formData.get('location'),
        plants: formData.get('plants'),
        user_id: 1, // Using demo user
        rows: parseInt(formData.get('rows')),
        cols: parseInt(formData.get('cols')),
        plot_states: plotStatesToSend  // Use the captured plot states
    };
    
    // Debug: Log what we're sending
    console.log('üì§ Sending garden data:', gardenData);
    console.log('üì§ Plot states array:', plotStatesToSend);
    console.log('üì§ Plot states length:', plotStatesToSend ? plotStatesToSend.length : 0);
    console.log('üì§ Rows x Cols:', gardenData.rows, 'x', gardenData.cols, '=', gardenData.rows * gardenData.cols);
    
    fetch('/api/gardens', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(gardenData)
    })
    .then(response => response.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('newGardenModal')).hide();
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create garden');
        // Re-enable button on error
        isSubmittingGarden = false;
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Join garden function
function joinGarden(gardenId, gardenName) {
    const message = prompt(`Enter a message to join "${gardenName}" (optional):`);
    
    // User cancelled
    if (message === null) return;
    
    fetch(`/api/gardens/${gardenId}/join`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: 1, // Demo user
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Join request sent successfully! Check your profile to see pending requests.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send join request');
    });
}

// Check follow status for all gardens on page load
document.addEventListener('DOMContentLoaded', function() {
    const gardenItems = document.querySelectorAll('.garden-item');
    gardenItems.forEach(item => {
        const followBtn = item.querySelector('.follow-btn');
        if (followBtn) {
            const gardenId = followBtn.id.split('-')[2];
            updateFollowButtonState(gardenId);
        }
    });
});

// Update follow button state
function updateFollowButtonState(gardenId) {
    fetch(`/api/gardens/${gardenId}/is-following?user_id=1`)
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById(`follow-btn-${gardenId}`);
            if (data.is_following) {
                btn.innerHTML = '<i class="fas fa-check"></i> Following';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            } else {
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
            }
        })
        .catch(error => console.error('Error checking follow status:', error));
}

// Toggle follow/unfollow garden
function toggleFollowGarden(gardenId, gardenName) {
    const btn = document.getElementById(`follow-btn-${gardenId}`);
    const isFollowing = btn.classList.contains('btn-outline-success');
    
    if (isFollowing) {
        // Unfollow
        fetch(`/api/gardens/${gardenId}/unfollow`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: 1 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                updateFollowButtonState(gardenId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to unfollow garden');
        });
    } else {
        // Follow
        fetch(`/api/gardens/${gardenId}/follow`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: 1 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                updateFollowButtonState(gardenId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to follow garden');
        });
    }
}

</script>
{% endblock %}